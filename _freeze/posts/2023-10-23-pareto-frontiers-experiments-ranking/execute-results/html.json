{
  "hash": "3ee17a1773ec8e9b37c653ea0fae908e",
  "result": {
    "markdown": "---\ntitle: Elliptical Pareto Frontiers for Experiments and Products\nauthor: Tom Cunningham, [Integrity Institute](https://integrityinstitute.org/)\nexecute:\n  echo: false\n  cache: true # caches chunk output\ndate: 2023-10-23\ndraft: true\nengine: knitr\nreference-location: margin\nfigure-location: margin\nformat:\n   html:\n      toc: true\n      toc-depth: 2\n      toc-location: left\n---\n\n<style>\n    h1 {  border-bottom: 4px solid black;  }\n    h2 {  border-bottom: 1px solid #ccc;}\n</style>\n\n<!-- See also: 2019-12-13-a-market-for-impact \n   TODO: state the implications about company strategy upfront\n   TODO: add a note about presenting at CODE\n   https://tecunningham.github.io/posts/2023-10-23-pareto-frontiers-experiments-ranking.html\n--> \n\n**Summary.**\n\n   Many business problems can be thought of as choosing a tradeoff between two metrics, X and Y. We show that the Pareto frontier between X and Y can be shown to be an ellipse in two cases: \n\n   1. If it is constructed by selecting from a pool of possible features, where the effect of each feature on X and Y is additive and is drawn from a joint Normal distribution; \n   2. If it is constructed from a recommender algorithm which shows the user a fixed set of items based on predictions, `p(X)` and `p(Y)`, and the predictions are drawn from a joint Normal distribution.\n   \n   This framework has implications for recommender systems, experimentation practice, and for setting priorities inside an organization.\n\n#                Introduction\n\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-1_65f6b62b4e00a7b511cf4a0f770e78ee'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n**Given a set of experiments we can draw a Pareto frontier.** Suppose we have a set of experiments, each of which can be characterized by its impact on two metrics, $\\Delta X$ and $\\Delta Y$. We visualize such a set of experiments at right.\n\nIf the set of features is *separable*, meaning that the impact of each feature is independent of what other features are launched, then a natural question will be the shape of the Pareto frontier formed by all possible combination of experiments.\n\nWe show below that, if the distribution of experiments is mean zero and joint normal, then the expected Pareto frontier will be an *ellipse*, and it will have exactly the shape of an isovalue of the density of experiments. Thus knowing the variance and covariance of experiment results allows us to characterize the nature of the Pareto frontier we face.\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-2_d478a89cf3391b522cbe297de3b454c2'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n**Given a set of classifier predictions we can draw a Pareto frontier.** Suppose we are choosing a fixed set of items to show to a user based on predictions of two outcomes, $x_1$ and $x_2$ (e.g. likes and comments, streams and dislikes, etc.).  A natural question will be the shape of the Pareto frontier formed by alternative selections of items. \n\nWe show below that, if the predictions are well calibrated, the outcomes are independent, and the distribution of prediction obeys a joint Normal distribution, then the Pareto frontier will be an *ellipse*, and it will have exactly the shape of an isovalue of the density of predictions.  Thus knowing the variance and covariance of predictions allows us to exactly characterize the nature of the aggregate tradeoffs we face.\n\n\\newpage\n#              Pareto Frontiers and Decision-Making\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-3_917b39c7a3aa2fb07c83ec0c243c405f'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-4_95dabcca0a35928fcdd14e984f945d9b'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n**Characterizing Pareto frontiers.** Suppose we are considering how much weight to put on metric $X$ vs metric $Y$ when making a product choice. We can characterize the effect of variation in the weight by drawing a Pareto frontier: the outcome will be the point on the Pareto frontier which has a slope equal to the ratio of weights on Y and X (i.e. where it is tangent with an indifference curve). We can distinguish between \"tight\" and \"loose\" Pareto frontiers. The first figure shows a tight tradeoff: in this case it doesn't matter whether we maximize X or Y or a weighted average, we'll end up in roughly the same place anyway. The second figure shows a loose tradeoff: in this case the outcome does depend substantially on the relative weight we put on $X$ and $Y$. Thus if, among experiments, we observe a high positive correlation between $\\Delta X$ and $\\Delta Y$ then the choice of shipping criteria is relatively unimportant: we should ship the same experiments anyway. Similarly if, among items in a recommender, we observe a high positive correlation between prediction of the two outcomes, then the choice of weights is relatively unimportant: we would show the same items anyway.\n\n**Tradeoffs are looser higher in the decision hierarchy.** We can distinguish between different levels of decision in the hierarchy of the firm:\n   $$\\substack{\\text{company objective}\\\\\\text{(choose headcount)}}\n      > \\substack{\\text{team objective}\\\\\\text{(choose projects)}}\n      > \\substack{\\text{shipping objective}\\\\\\text{(choose experiments)}}\n      > \\substack{\\text{algorithm objective}\\\\\\text{(choose items)}}$$\n   We can think of each successive level as holding more variables fixed, and so we expect the Pareto frontiers to become successively tighter (Le Chatelier principle). We thus expect the tradeoff to be loosest at the level of overall company objectives, where we reallocate headcount. For this reason we should expect that, if the company as a whole pivots form metric X to metric Y, the principal effect will be a reallocation of effort *between* products rather than reallocation *within* products.\n\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-5_eba4431b68c321f870e182b3e94c7563'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-6_386db363840d3c21641c2e0d255143b2'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n**Different product areas have different Pareto frontiers.** Typically two different product areas will have substantially different ability to affect different metrics, and we may observe a situation like that shown on the right: team A primarily moves metric $X$, team B primarily moves metric $Y$. We can also draw a *combined* Pareto frontier, just adding up the effects on each. In this case neither invidual Pareto frontier shows a substantial effect from changing weights (if we restrict weights to be positive), and so accordingly the combined Pareto frontier shows little response to a change in weights.\n\n\n<!-- \\marginnote{\\begin{tikzpicture}[scale=3]\n   \\draw (0,1) -- node[rotate=90,above] {$\\Delta$Y} (0,0)\n      -- node[below] {$\\Delta$X}(1,0) -- (1,1)  -- (0,1);\n   \\begin{scope}\n    \\clip(0,0) rectangle (1,1);\n    \\draw[color=red, dashed] (0,0) circle[x radius=.7, y radius=.05, rotate=80];\n    \\draw[color=blue, dashed] (0,0) circle[x radius=.7, y radius=.05, rotate=10];\n    \\draw[color=red, line width=2] (0,0) circle[x radius=.7, y radius=.1, rotate=80];\n    \\draw[color=blue, line width=2] (0,0) circle[x radius=.7, y radius=.1, rotate=10];\n   \\end{scope}\n   \\node at (.5,.25) {team A};\n   \\node at (.3,.8) {team B};\n\\end{tikzpicture}}\n**Pareto frontiers will expand if we allow for investment in different features.** Suppose we do not take the set of existing features as given (i.e. those chosen under the current weights) but instead allow a team to work on alternative features. Then we should expect a somewhat broader set of tradeoffs, i.e. the Pareto frontiers should expand. This reflects investing in new ideas: e.g. team A could come up with features that would have a larger-than-usual impact on Y, and team B might come up with features that would have a larger-than-usual impact on X. -->\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-7_eac2ec3fe8737585d988ee9e34c68539'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n**Greater investment will shift Pareto frontiers out.** Here we visualize reallocating employees from team B (the frontier shifts in) to team A (the frontier shifts out).\n\n\n\\vspace{3cm}\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-8_4c7c51917416764de50864fe8750ed95'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n**A combined company Pareto frontier will be loose.** If we allow the company to reallocate resources between teams in response to a change in goals then the set of possible tradeoffs will become very broad.\n\n\\newpage\n\n#                 Model\n\nSuppose we have a set of items with, $x_1$ and $x_2$, distributed Normally:\n   $$\\binom{x_1}{x_2}\\sim N\\left(\\binom{0}{0},\n      \\begin{pmatrix}\\sigma_1^2 & \\rho\\sigma_1\\sigma_2 \\\\ \\rho\\sigma_1\\sigma_2 & \\sigma_2^2\\end{pmatrix}\\right).$$\n\nWe additionally let each item have a *score*, $v$, which is simply a weighted sum of the two characteristics (normalizing the weight on the first characteristic to be 1):\n   $$v=x_1 + wx_2.$$\n\nWe can write the covariance between the characteristics and the score as follows:\n\n$$Cov\\begin{bmatrix}x_1\\\\x_2\\\\v\\end{bmatrix}=\n \\begin{bmatrix}\n    \\sigma^2_1           & \\sigma_1\\sigma_2\\rho & \\sigma_1^2+ w\\rho\\sigma_1\\sigma_2 \\\\\n    \\sigma_1\\sigma_2\\rho &  \\sigma_2^2          & \\rho\\sigma_1\\sigma_2+w\\sigma_2^2 \\\\\n    \\sigma_1^2+w\\rho\\sigma_1\\sigma_2          &\n          \\rho\\sigma_1\\sigma_2+w\\sigma_2^2    &\n          \\sigma_1^2+w^2\\sigma_2^2 + 2\\rho w\\sigma_1\\sigma_2 \\\\\n \\end{bmatrix}$$\n\nWe wish to know the total number of actions of each type, $X_1$ and $X_2$, for a given score threshold $\\bar{v}$:\n\n$$\\begin{aligned}\n   X_1   &=P(v\\geq \\bar{v})E[x_1|v\\geq \\bar{v}] \\\\\n   X_2   &=P(v\\geq \\bar{v})E[x_2|v\\geq \\bar{v}].\n\\end{aligned}$$\n\nWe first calculate the conditional expectations:\n\n$$\\begin{aligned}\n E[x_1|v\\geq \\bar{v}]\n   =& \\sigma_1 \\frac{Cov(x_1,v)}{\\sqrt{Var(x_1)Var(v)}}\n      \\frac{\\phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})}{\\Phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})} \\\\\n   =& \\sigma_1\n      \\frac{\\sigma_1^2+w\\rho\\sigma_1\\sigma_2}\n         {\\sqrt{\\sigma_1^2(\\sigma_1^2+w^2\\sigma_2^2 + 2\\rho w\\sigma_1\\sigma_2)}}\n      \\frac{\\phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})}{\\Phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})}\\\\\n  =&  \\frac{\\sigma_1^2+w\\rho\\sigma_1\\sigma_2}\n           {\\sqrt{\\sigma_1^2+w^2\\sigma_2^2 + 2\\rho w\\sigma_1\\sigma_2}}\n   \\frac{\\phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})}{\\Phi(\\frac{\\bar{v}}{\\sqrt{Var(v)}})}\n\\end{aligned}$$\n\nNext we will assume that the expected quantity of items is fixed. This implies that both both $P(v\\geq \\bar{v})$ and $\\frac{\\bar{v}}{\\sqrt{Var(v)}}$ will be constant, and we will define: \n   $$\\begin{aligned}\n      \\gamma\\equiv\n         &\\frac{\\phi\\left(\\frac{\\bar{v}}{\\sqrt{Var(v)}}\\right)}\n            {\\Phi\\left(\\frac{\\bar{v}}{\\sqrt{Var(v)}}\\right)}P(w\\geq w^*) \\\\\n      X_1 =& \\frac{\\sigma_1^2+w\\rho\\sigma_1\\sigma_2}\n                  {\\sqrt{\\sigma_1^2+w^2\\sigma_2^2 + 2\\rho w\\sigma_1\\sigma_2}}\\gamma \\\\\n      X_2 =& \\frac{w\\sigma_2^2+\\rho\\sigma_1\\sigma_2}\n                  {\\sqrt{\\sigma_1^2+w^2\\sigma_2^2 + 2\\rho w\\sigma_1\\sigma_2}}\\gamma\n   \\end{aligned}$$\n\nWe thus have expressions for $X_1$ and $X_2$ as a function of the relative weight $w$. We wish to rearrange these to express $X_1$ directly in terms of $X_2$. To help we turn to Mathematica, with the following input:^[[see notebook](https://www.wolframcloud.com/env/tomcunningham/Ellipses.nb)]\n\n```\nF1[w_,p_,s1_,s2_,g_]:=g(s1^2+w p s1 s2 )/Sqrt[s1^2+w^2 s2^2+2w p s1 s2]\nF2[w_,p_,s1_,s2_,g_]:=g(w s2^2 +p s1 s2)/Sqrt[s1^2+w^2 s2^2+2w p s1 s2]\nSolve[{X1==F1[w,p,s1,s2,g],X2==F2[w,p,s1,s2,g]}, {X1,w}]\nSimplify[First[%1]]\n```\n\nThis returns a large expression:\n\n$$\\begin{aligned}\n   X_1(X_2) &= \n      \\frac{\n         g^2 \\rho s_1 s_2^3 X_2\n         - p s_1 s_2 X_2^3\n         + g^3 s_2^4\n            \\sqrt{\\frac{-g^2 (-1 + p^2) s_1^2 s_2^2}{g^2 s_2^2 - X_2^2}} \n         - g s_2^2 X_2^2\n            \\sqrt{-\\frac{g^2 (-1 + p^2) s_1^2 s_2^2}{ g^2 s_2^2 - X_2^2}} \n         + X_2 \\sqrt{(-1 + p^2) s_1^2 s_2^2 X_2^2 (-g^2 s_2^2 + X_2^2)}\n      }{g^2 s_2^4 - s_2^2 X_2^2}\\end{aligned}$$\n\nWe can however substantially simplify this:\n$$\\begin{aligned}\n   X_1 &= \\frac{\n         s_1s_2X_2 (g^2 \\rho s_2^2  - p X_2^2)\n         + g^2s_2^2(g^2 s_2^2-  X_2^2)\n            \\sqrt{-\\frac{(-1 + p^2) s_1^2 s_2^2}{g^2 s_2^2 - X_2^2}} \n         - X_2^2s_1s_2 \\sqrt{(p^2-1) (g^2 s_2^2-X_2^2)}\n      }{g^2 s_2^4 - s_2^2 X_2^2} \\\\\n   &= \\frac{\n         s_1s_2X_2 p(g^2 s_2^2  - X_2^2)\n         + gs_2^3s_1 g\n            \\sqrt{(p^2-1)(g^2 s_2^2 - X_2^2)} \n         - X_2^2s_1s_2 \\sqrt{(p^2-1) (g^2 s_2^2-X_2^2)}\n      }{s_2^2(g^2 s_2^2 - X_2^2)} \\\\\n   &= \\frac{s_1}{s_2}X_2p + \\frac{\n         s_1s_2(g^2s_2^2 - X_2^2 )\n            \\sqrt{(p^2-1) (X_2^2-g^2 s_2^2)}\n      }{s_2^2(g^2 s_2^2 - X_2^2)} \\\\\n   &= X_2 \\rho \\frac{s_1}{s_2}\n      +\\frac{s_1}{s_2}\\sqrt{(p^2-1) (X_2^2-g^2 s_2^2)}.\n\\end{aligned}$$\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-9_2b62d31d4755f1e09bf7edfc7a336d65'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nWe now wish to show that this curve is equal to an isovalue of the joint distribution of $x_1$ and $x_2$ (illustrated at right). We can write the isovalue of the joint Normal distribution of $(x_1,x_2)$ as follows:^[From Section 4.7 of the 1st edition (2002) of the book Introduction to Probability, by D. P. Bertsekas and J. N. Tsitsiklis, <http://athenasc.com/Bivariate-Normal.pdf>]\n\n   $$k = \\frac{x_1^2}{\\sigma_1^2}+\\frac{x_2^2}{\\sigma_2^2}-2\\rho\\frac{x_1x_2}{\\sigma_1\\sigma_2}.$$\n\nSolving this quadratic we can write:\n   $$\\begin{aligned}\n      x_1 &= x_2 \\rho \\frac{\\sigma_1}{\\sigma_2} \n               \\pm \\frac{\\sigma_1}{\\sigma_2}\\sqrt{-x_2^2+x_2^2\\rho^2+k\\sigma_2^2} \\\\\n         &= x_2 \\rho \\frac{\\sigma_1}{\\sigma_2} \n               \\pm \\frac{\\sigma_1}{\\sigma_2}\\sqrt{k\\sigma_2^2-(1-\\rho^2)x_2^2}.\n   \\end{aligned}$$\n\nWe can see that the two curves will be equal where $k=\\frac{\\sigma_2^2}{\\sigma_1^2}(\\rho^2-1)g^2$.\n\n<!-- \n#                    Additional Material\n\n##          Using Pareto Frontiers for Launch Decisions\n\n\n##          Pareto Frontiers and Network Effects\n\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-10_ae3fde58fa6155daa03e922e944b4708'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-10-23-pareto-frontiers-experiments-ranking_cache/html/unnamed-chunk-11_ee5d7e4601df5dd75485064b950e1226'}\n::: {.cell-output-display}\n![](2023-10-23-pareto-frontiers-experiments-ranking_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n-->\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}