{
  "hash": "b0d857865ecb1587c4427cae03710f85",
  "result": {
    "markdown": "---\ntitle: Runner Percentile Calculation\nauthor: Tom Cunningham\ndate: 2023-08-11\ndraft: true\nexecute:\n  echo: false\n  cache: true # caches chunk output\nfig-align: center\nreference-location: margin\nformat:\n   html:\n      toc: true\n      toc-depth: 2\n      toc-location: left\n      code-fold: true\n      html-math-method:\n         method: mathjax\n         url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg-full.js\"\n         #     ^ this forces SVG instead of CHTML, otherwise xypic renders weird\n      include-in-header:\n         - text: |\n            <script>window.MathJax = {\n                     loader: { load: ['[custom]/xypic.js'],\n                                 paths: {custom: 'https://cdn.jsdelivr.net/gh/sonoisa/XyJax-v3@3.0.1/build/'}},\n                  tex: {packages: {'[+]': ['xypic']},\n                     macros: {\n                        bm: [\"\\\\boldsymbol{#1}\", 1],\n                        ut: [\"\\\\underbrace{#1}_{\\\\text{#2}}\", 2],\n                        utt: [\"\\\\underbrace{#1}_{\\\\substack{\\\\text{#2}\\\\\\\\\\\\text{#3}}}\", 3]\n                     }}};\n            </script>\n\nengine: knitr\neditor:\n   render-on-save: true\n---\n\n<style>\n   h1 {  border-bottom: 4px solid black;}\n   h2 {  border-bottom: 1px solid gray; padding-bottom: 0px; font-size: 14px; color: black; }\n   dl {display: grid;grid-template-columns: max-content auto;}\n   dt {grid-column-start: 1;}\n   dd {grid-column-start: 2; margin-left: 2em;}\n</style>\n\n- **Suppose you pass 100 times as many runners as pass you.**\n- **Then there are only 10 times as many runners who you are faster than, than runners who are faster than you.**\n\n- You're less likely to pass, or be passed by, a runner whose speed is close to yours. So if you're faster than 90% of runners you pass (or are passed by) this doesn't imply you're faster than 90% of all runners.\n- If we assume the distribution is normal.\n\n#           FB Post\n\nMy claim: keeping track of people you pass when you run will typically *exaggerate* your ranking in relative speed, e.g. if you pass people by with a ratio of 3:1 then you're probably not at the 75th percentile of speeds, you're significantly lower than that. (However this requires a sufficiently thin-tailed distribution of speeds).\n\nMore formally:\n\nWITHOUT ASSUMPTION ON DISTRIBUTION\n\n1. I cannot infer anything certain about my rank. Given the ratio of pass/passed-by, I could be either the fastest or the slowest runner. E.g. suppose the majority of runners were just slightly faster than me, but a few runners who were much slower, then I would pass many more runners than I passed by, but nevertheless my rank among runners would be low.\n\n2. I can infer whether I'm faster or slower than average. If the number of people who pass me is equal to the number of people who I'm passed by then I must be going the *average* speed. If I pass more than I'm passed by then I must be going faster than average. As a corollary: if the distribution is symmetric (mean=median) then if you pass more people than you're passed by then you must have above-median speed.\n\nWITH ASSUMPTION ON DISTRIBUTION\n\nLet's say that \"exaggeration\" holds if your position in the passing distribution (passes/(passes+passedby)) is farther from 50% than your percentile in the distribution of speeds (faster/(faster+slower)).\n\n1. If speeds are uniform then there's a very simple solution, and exaggeration will always hold. The ratio of faster/slower will be equal to the square root of the ratio of passes/passed-by. E.g. if I pass 100X as many people as I pass by, then there will be only 10X as many people who I'm faster than than who I'm slower than. There's a simple graphical derivation: the volume of people I pass (and are passed by) will be given by the area of triangles on either side of my speed, and the areas of those triangles are proportional to the square of the number of runners.\n\n2. If I assume a Normal distribution then there's an analytic solution. The solution is a little bit ugly but exaggeration always holds: i.e. the share of people you pass always exceeds your percentile in the speed distribution.\n\nHowever with a t-distribution exaggeration with low degrees of freedom then exaggeration won't always hold. I think there must be some condition on how fat-tailed the distribution is for exaggeration to hold.\n\n#           Summary\n\n**Key: the frequency of two runners passing will be proportional to the difference in speeds.** If two runners run at exactly the same speed then they'll never pass, if they run at very different speeds they'll pass often. So we can express the number of runners who pass/passed in given unit of time as follows:\n   $$\\begin{aligned}\n      s &= \\text{my speed} \\\\\n      x &\\sim \\phi, \\text{other runners' speeds} \\\\\n      p=\\text{runners I pass}\n         &= \\int_{-\\infty}^s \\utt{\\phi(x)}{runners}{at speed $x$}\\utt{(s-x)}{frequency}{we pass}dx\\\\\n         &= s\\Phi(s)-\\int_{-\\infty}^sx\\phi(x)dx \\\\\n      q= \\text{runners who pass me}\n         &= \\int_{s}^\\infty \\utt{\\phi(x)}{runners}{at speed $x$}\\utt{(x-s)}{frequency}{we pass}dx\\\\\n         &= \\int_{s}^{\\infty}x\\phi(x)dx-s(1-\\Phi(s)) \\\\\n      r=\\text{ratio pass/passed}\n         &= \\frac{s\\Phi(s)-\\int_{-\\infty}^sx\\phi(x)dx}\n            {\\int_{s}^{\\infty}x\\phi(x)dx-s(1-\\Phi(s))} \\\\\n         &= \\frac{E[s-x|x<s]}{E[x-s|x>s]}\\frac{P(x<s)}{P(x>s)}\n   \\end{aligned}$$\n\nThis last condition is the most important. It implies you can figure out your rank among runners $\\frac{P(x<s)}{P(x>s)}$ if you know the relative distance in speeds among those who are faster and those who are slower. If the speed differences are identical then the two ratios are the same. For most distributions (e.g. the normal) the conditional expectations will be such that the slower guys are closer than the faster, implying the exaggeration property.\n\nNote on conditional expectations:\n$$\\begin{aligned}\n   E[x|x<s]\n      &= \\frac{\\int_{-\\infty}^s x\\phi(x)dx}{\\Phi(s)}\\\\\n      &= s-\\frac{p}{\\Phi(s)}\n      && \\text{(from above)} \\\\\n   E[x|x>s]\n      &= \\frac{\\int_{s}^{\\infty} x\\phi(x)dx}{1-\\Phi(s)}\\\\\n      &= s+\\frac{q}{(1-\\Phi(s))}\\\\\n   \\frac{E[x|x<s]-s}{E[x|x>s]-s}\n      &= -\\frac{p}{q}\\frac{1-\\Phi(s)}{\\Phi(s)}\\\\\n   r=\\frac{p}{q}\n      &= \\frac{E[s-x|x<s]P(x<s)}{E[x-s|x>s]P(x>s)}\n\\end{aligned}$$\n\n\n#          Uniform Distribution of Speeds\n\nWith a uniform distribution you can easily see that the number of passings is proportional to the area of the triangle, and so proportional to the *square* of the number of runners below/above your speed.\n\n\n::: {.cell hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-1_952d91abb570367f918b6818066588e6'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n#          Normal Distribution of Speeds\n\n\n::: {.cell .column-margin hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-2_03ddf149a1bb2dea797b07e601f29641'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-3_d500f10e7ad4c4cb290380fcfb368349'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-4_91c13ed99fa1c2f654bac2f8e54e5813'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell .column-margin hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-5_f02d49a7ad3257653af367e666a43eb7'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n<!-- ```{tikz}\n#| column: margin\n\\pgfmathdeclarefunction{gauss}{3}{\\pgfmathparse{1/(#3*sqrt(2*pi))*exp(-((#1-#2)^2)/(2*#3^2))}}\n\\tikzset{declare function={normcdf(\\x,\\m,\\s)=1/(1 + exp(-0.07056*((\\x-\\m)/\\s)^3 - 1.5976*(\\x-\\m)/\\s));}}\n\\begin{tikzpicture}\n   \\draw[<->] (-2,2) -- (-2,0) node[rotate=90,midway,above,align=center]{ratio}-- (2,0) node[midway,below] {my speed};\n   \\draw[domain=-2:2] (-2,0) -- plot({\\x},{(gauss(\\x,0,1)+\\x*normcdf(\\x,0,1))/(2*gauss(\\x,0,1)+\\x*normcdf(\\x,0,1)-\\x)}) -- (2,0);\n   \\draw[domain=-2:2,red] (-2,0) -- plot({\\x},{(normcdf(\\x,0,1))/(1-normcdf(\\x,0,1))}) -- (2,0);\n   \\draw[dashed] (0,0)--(0,1);\n   \\node at (0,2) {ratio};\n\\end{tikzpicture}\n``` -->\n\n::: {.cell hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-6_8ed5226d8a871a158e53fb079fb300f1'}\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n$$\\begin{aligned}\n   s &= \\text{my speed} \\\\\n   x &\\sim \\phi, \\text{other runners' speeds} \\\\\n   \\text{runners I pass}\n      &= \\int_{-\\infty}^s \\utt{\\phi(x)}{runners w}{speed $x$}\\utt{(s-x)}{prob I}{pass them}dx\\\\\n      &= s\\Phi(s) - \\int_{-\\infty}^s x\\phi(x) dx \\\\\n      &= s \\Phi(s) + \\phi(s) \\\\\n      & \\text{(last step uses $\\phi=N(0,1)$)}\\\\\n   \\text{runners who pass me}\n      &= \\int_{s}^\\infty \\utt{\\phi(x)}{runners w}{speed $x$}\\utt{(x-s)}{prob they}{pass me}dx\\\\\n      &= \\left[  -\\phi(x) -s\\Phi(x)  \\right]^\\infty_s \\\\\n      &= (0+\\phi(s)) - (s-s\\Phi(s))\\\\\n      &= \\phi(s) - s + s\\Phi(s) \\\\\n   r=\\text{ratio pass/passed by}\n      &= \\frac{s\\Phi(s)+\\phi(s)}{\\phi(s)+s\\Phi(s)-s}\\\\\n   \\text{share I pass}\n      &= \\frac{s \\Phi(s) + \\phi(s)}{s \\Phi(s) + \\phi(s)+\\phi(s) - s + s\\Phi(s)} \\\\\n      &= \\frac{s \\Phi(s) + \\phi(s)}{2s\\Phi(s) + 2\\phi(s) - s}\n\\end{aligned}$$\n\n**Note on derivatives:**\n\n\n$$\\begin{aligned}\n   \\phi(x) &= \\frac{1}{\\sqrt{2\\pi}}e^{-x^2/2}\n      && \\text{(standard normal)}\\\\\n   \\phi'(x) &= -x\\phi(x)\n\\end{aligned}$$\n\n#                 Simulations\n\n\n::: {.cell hash='2023-08-13-runner-percentile_cache/html/unnamed-chunk-7_9a815a0ababf28b9b926c8c1c68ff57e'}\n::: {.cell-output .cell-output-stdout}\n```\n[1] 29.55388\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 9.330527\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.7791446\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.6914625\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 95716730  4576917\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1]  8.652357 14.289082\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 57.60283 52.84557\n```\n:::\n\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](2023-08-13-runner-percentile_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\nEach cell shows first the ratio pass/passed, then the ratio faster/slower $\\frac{\\Phi(s)}{1-\\Phi(s)}$. We can see that exaggeration holds in each cell.\n\nNote that t with df=1 is weird because it doesn't have an expectation, i.e. $x\\phi(x)$ never goes to zero, so confusing to think about.\n\n| $s$ | gauss    | t(df=1)  | t(df=2)   |\n| --- | -------- | -------- | --------- |\n| -1  | .08 / .2 | .5/.3    | .26/.28   |\n| 0   | 1/1      | 1/1      | 1/1       |\n| 0.5 | 3.5/2.4  | 1.4/1.9  | 2.0/2.1   |\n| 1   | 13.0/5.8 | 1.9/3.0  | 3.8/4.0   |\n| 2   | 238/49   | 3.2/5.8  | 10.3/10.3 |\n| 10  | 95M/4M   | 8.6/14.3 | 58/53     |\n\n\n#                 Post\n\nSuppose you go for a run and you pass 90% of people you see (the other 10% of people pass you). What's your overall rank in the distribution of speeds?\n\nWe can't know for sure but if you assume the distribution of speeds is Normal then you're at approximately 80% (i.e. 80% of runners are slower, 20% are faster). The asymmetry is because you're relatively less likely to pass (or be passed by) people who run at a similar speed as you.\n\n#           R simulation\n\n```\npass <- function(x) {\n   x * pnorm(x) + 2 * dnorm(x)\n}\npassed <- function(x) {\n   x * pnorm(x) + 2 * dnorm(x) - x\n}\nshare <- function(x) {\n   pass(x) / (pass(x) + passed(x))\n}\n\n\n\nx <- 0\ndensity <- dnorm\n\npass_sum(0, function(x) {\n   dt(x, df = 1)\n})\npass_sum(0, function(x) {\n   dt(x, df = 5)\n})\n\n\npassed_sum <- function(x) {\n   integral <- 0\n   for (speed in seq(x, 10, 0.1)) {\n      integral <- integral + dnorm(speed) * (speed - x) * 0.1\n   }\n   return(integral)\n}\nshare_sum <- function(x) {\n   pass_sum(x) / (pass_sum(x) + passed_sum(x))\n}\n\npass(0)\npass_sum(0)\n\npassed(.5)\n\nshare(.5)\npnorm(.5)\nshare_sum(.5)\n\n```\n -->\n#           References\n\n**Mathoverflow [\"You pass X people and Y people pass you: how relatively fast are you?\"](https://mathoverflow.net/questions/40913/you-pass-x-people-and-y-people-pass-you-how-relatively-fast-are-you)**\n   \n   There are a number of sketches of answers but no explicit solutions. A few answers wrongly conclude that the ratio of overtakes/overtakens is equal to the ratio of faster/slower runners.\n\n**Clevenson, Schilling, Watkins and Watkins (2001) \"The Average Speed on the Highway\"**\n\n   They show that if the number of cars you pass is equal to the number of cars that pass you  then you must be driving the average speed (not necessarily the median speed).\n\n\n#           Conclusions\n\nSuppose your speed is $s$ and the runners' speeds have distribution $X\\sim\\phi$, and $r$ is the ratio of passed ",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}