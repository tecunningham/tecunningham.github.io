<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tom Cunningham">
<meta name="description" content="Tom Cunningham blog">

<title>Selling Shovels | Tom Cunningham – Tom Cunningham</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d5e7c60e6424aa6ccf163f01508596ce.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-12027453-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<script>window.MathJax = {
   loader: { load: ["https://cdn.jsdelivr.net/gh/sonoisa/XyJax-v3@3.0.1/build/xypic.js"]},
   tex: {packages: {'[+]': ['xypic','bm']},
         macros: {  bm: ["\\boldsymbol{#1}", 1],
                    ut: ["\\underbrace{#1}_{\\text{#2}}", 2],
                    utt: ["\\underbrace{#1}_{\\substack{\\text{#2}\\\\\\text{#3}}}", 3] }
   }
};
</script>
<style>
   h1 {  border-bottom: 8px solid #557;}
   h2 {  border-bottom: 1px solid #ccc;}
   .greyproof {
      background-color: #f5f5f5;
      padding: 1em;
      margin: 1em 0;
      border-radius: 4px;
   }
</style>
<meta name="quarto:status" content="draft">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Selling Shovels | Tom Cunningham">
<meta name="twitter:description" content="Tom Cunningham blog">
<meta name="twitter:image" content="tecunningham.github.io/posts/images/2025-12-24-06-14-37.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tom Cunningham</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href=".././about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/testingham"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tom-cunningham-a9433/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://tecunningham.github.io/index.xml"> <i class="bi bi-rss-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=MDB_DgkAAAAJ"> 
<span class="menu-text">scholar</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Selling Shovels</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<dl>
<dt>Claim: labs will switch from selling shovels to using the shovels.</dt>
<dd>
As the models get stronger labs will stop selling access to the models, and instead use the models themselves to create artefacts (algorithms, videos, scientific discoveries), and then selling those artefacts.
</dd>
<dt>Examples:</dt>
<dd>
<ul>
<li>Create a movie</li>
<li>Predict stock prices &amp; trade on them</li>
<li>Optimize a widely-used algorithm</li>
<li>Optimize a widely-used technology</li>
<li>Make a scientific discovery</li>
</ul>
</dd>
<dt>Observations on modeling this:</dt>
<dd>
<ol type="1">
<li><em>Probably can ignore inference costs.</em> – seems like main implications are just from value side, &amp; ignoring cost.</li>
<li><em>Distinction between local vs global value.</em> – (not quite rivalness or excludability, but correlation in value).</li>
<li><em>Distinction between large and small problem.</em></li>
</ol>
</dd>
<dt>Theory on residual rights.</dt>
<dd>
Suppose there are two factors, it’s efficient to assign ownership (residual rights) to the factor which has less-observable inputs (“the party whose investment is most important and most difficult to specify in a contract”).
</dd>
<dt>Who could I get to coauthor?</dt>
<dd>
<p>Erik B; Andrey; Philip Trammel; Basil; <em>Andy Haupt</em>.</p>
<p>Hi Phil, Basil, Andy. Merry christmas! I’ve written up a one-page note on an issue I think is important, &amp; I’m looking for a coauthor, in case I could tempt any of you. I’m personally persuaded this is going to be a big deal, &amp; I feel I haven’t seen public discussion of this issue, so keen to get this out somewhere. (&amp; FWIW my expectation is partly informed by my industry experience.)</p>
</dd>
</dl>
<section id="models" class="level2">
<h2 class="anchored" data-anchor-id="models">Models</h2>
<dl>
<dt>Small problems vs big problems (demand curve).</dt>
<dd>
<ul>
<li>The old model can solve a lot of $1 problems, the new model can solve a few $1M problems.</li>
<li>Can think of this as steepening of the demand curve, so it becomes optimal to raise the price. But by itself this doesn’t have implications for rent-vs-own or buy-vs-build.</li>
</ul>
</dd>
<dt>Global value vs local value.</dt>
<dd>
<ul>
<li>Suppose old models solve <em>local</em> problems, &amp; new models solve <em>global</em> problems (nonrival).</li>
<li>Suppose the total surplus generated in each case is the same.</li>
<li>Village example: (1) you dig a well and sell the water; (2) you build a library and sell access.</li>
<li>If you sell the inputs to build a nonrival good, then can’t charge a premium for it.</li>
</ul>
</dd>
<dt>Unobservable inputs.</dt>
<dd>
<ul>
<li>Suppose output depends on inputs from humans and from the AI, what’s the efficient allocation of ownership of the outputs?</li>
<li>Oliver Hart says “ownership should be allocated to the party whose investment is most important and most difficult to specify in a contract.”</li>
<li>For existing models it’s difficult to specify the human inputs in a contract.</li>
<li>However as new models get better it’s easier to specify them.</li>
</ul>
</dd>
<dt>Human-level vs superhuman (M&amp;M model).</dt>
<dd>
<ul>
<li>Each human has a knowledge set, allows them to produce certain goods.</li>
<li>Assume symmetric demand across goods (and σ&gt;1), pins down sorting of people to goods.</li>
<li>Old AI gives people existing skills.</li>
<li>New AI gives people new skills.</li>
</ul>
</dd>
<dt>Vertical integration.</dt>
<dd>

</dd>
</dl>
<p>(note: Dixit-Stiglitz love-of-variety CES has <span class="math inline">\(\sigma&gt;1\)</span>, i.e.&nbsp;gross substitutes, otherwise you get pathological cases)</p>
</section>
<section id="ownership-residual-rights" class="level2">
<h2 class="anchored" data-anchor-id="ownership-residual-rights">ownership / residual rights</h2>
<dl>
<dt>Alchian and Demsetz (1972):</dt>
<dd>
<blockquote class="blockquote">
<p>““The essential role of the firm is to economize on the costs of measuring marginal productivities. … the monitor must be the residual claimant.”</p>
</blockquote>
</dd>
<dt>Fama and Jensen (1983):</dt>
<dd>
<blockquote class="blockquote">
<p>“Efficient organization assigns residual claims to those with the greatest incentives to monitor and control.</p>
</blockquote>
</dd>
<dt>Hart (1995):</dt>
<dd>
<blockquote class="blockquote">
<p>**“Ownership should be allocated to the party whose investment is most important and most difficult to specify in a contract.** … The owner of an asset has the right to decide on its use in all contingencies not specified in the contract, and hence ownership confers bargaining power when investments are non-verifiable.”</p>
</blockquote>
</dd>
<dt>Examples:</dt>
<dd>
<blockquote class="blockquote">
<p>“If a fisherman rents a boat, then when unforeseen contingencies arise the owner of the boat has control. If instead the fisherman owns the boat, then he has control over its use in all circumstances not specified in the contract.”</p>
</blockquote>
</dd>
<dd>
<blockquote class="blockquote">
<p>“When a worker’s actions are hard to specify, it may be optimal for the firm to hire the worker and own the output, rather than contract for a finished good.”</p>
</blockquote>
</dd>
</dl>
</section>
<section id="post-on-metr-slack" class="level2">
<h2 class="anchored" data-anchor-id="post-on-metr-slack">post on METR slack</h2>
<p>I feel that in 2026 we’re going to get a blast of capabilities from a direction we’re not expecting. Specifically using a lot of inference to optimize on a single task:</p>
<ul>
<li>Create a movie</li>
<li>Predict stock prices</li>
<li>Optimize algorithms</li>
<li>Optimize technology</li>
<li>Solve scientific problems</li>
</ul>
<p>You want to spend a ton of tokens going deep on a single problem, and you can have a semi-custom architecture for this. Labs wouldn’t want to <em>sell</em> this ability to customers, it makes more economic sense to <em>use</em> the technology internally and then sell the product you’ve create with it.</p>
<p>This makes me a bit more anxious about AI R&amp;D ability not being publicly observable, because AI R&amp;D is a type of optimization problem, &amp; it seems likely that labs will postpone releasing this technology publicly.</p>
</section>
<section id="shovels-metaphor" class="level2">
<h2 class="anchored" data-anchor-id="shovels-metaphor">shovels metaphor</h2>
<p>Suppose you have a lot of shovels:</p>
<ol type="1">
<li>The valley is full of gold flakes everywhere, then you make money selling shovels to other people.</li>
<li>The valley has one large gold nugget burried deep, then you use the shovels yourself to dig it out yourself.</li>
</ol>
<p>original quote, but not clear provenance:</p>
<blockquote class="blockquote">
<p>“When Everybody Is Digging for Gold, It’s Good To Be in the Pick and Shovel Business”</p>
</blockquote>
</section>
<section id="monopoly-in-general-equilibrium" class="level2">
<h2 class="anchored" data-anchor-id="monopoly-in-general-equilibrium">2025-12-24 | monopoly in general equilibrium</h2>
<ol type="1">
<li><p><strong>TLDR: you can now choose the price vector.</strong></p></li>
<li><p><strong>In an Edgeworth box, the other guy’s offer curve is now your budget constraint.</strong></p></li>
<li><p><strong>If e=1 (Cobb-Douglas), offer curves will be straight lines:</strong></p>
<p><img src="images/2025-12-24-06-14-37.png" class="img-fluid"></p>
<ul>
<li>I can get half his loaves, while giving away almost zero fishes.</li>
</ul></li>
<li><p><strong>If gross complements you can get everything from the other guy.</strong></p></li>
</ol>
<p><img src="images/2025-12-24-06-20-29.png" class="img-fluid"></p>
<ol start="5" type="1">
<li><strong>If gross substitutes you can only get a little extra surplus.</strong></li>
</ol>
<p><img src="images/2025-12-28-06-38-42.png" class="img-fluid"></p>
<p><a href="https://chatgpt.com/share/695141da-a83c-8013-8366-e1caa9c5e9c1">ChatGPT diagrams</a></p>
<hr>
<p><a href="https://www.lonessmith.com/wp-content/uploads/2020/09/7-GE-in-Exchange-Economies-1.pdf">Lones Smith notes on monopoly in general equilibrium</a></p>
<ul>
<li>Monopolist “seeks his highest indifference curve on Iris’s TOC [trade offer curve]”</li>
<li>Nice point that monopolist can do even better with a two-part tariff.</li>
</ul>
</section>
<section id="references-from-elsa-jiang" class="level1">
<h1>2025-12-29 | references from Elsa Jiang</h1>
<p><a href="https://x.com/NaveenGRao/status/1886544584588619840">Naveen Rao, Databricks VP, Feb 2025</a></p>
<blockquote class="blockquote">
<p>“Prediction: all closed AI model providers will stop selling APIs in the next 2-3 years. Only open models will be available via APIs.</p>
</blockquote>
<blockquote class="blockquote">
<p>“Why? For an open model service, the value prop is clear…it’s hard to build a scalable service to access the model and the model is commodity. The race-to-the bottom happened with the commodity already (model). Let AI app builders iterate on great UIs for apps upon scalable services with commodity capabilities</p>
</blockquote>
<blockquote class="blockquote">
<p>“Closed model providers are trying to build non-commodity capabilities and they need great UIs to deliver those. It’s not just a model anymore, but an app with a UI for a purpose.</p>
</blockquote>
<blockquote class="blockquote">
<p>“If closed models are available via API, all it does is create competition for the app the closed provider is building. The secret sauce is capabilities + UI.”</p>
</blockquote>
<p>Alexander Doria <a href="https://vintagedata.org/blog/posts/model-is-the-product">“The Model is the Product”</a></p>
<p>(says that models will do eveyrhting, you don’t need a wrapper)</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("tecunningham\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>