<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tom Cunningham">
<meta name="dcterms.date" content="2023-05-08">
<meta name="description" content="Tom Cunningham blog">

<title>Ranking by Engagement | Tom Cunningham – Tom Cunningham</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-12027453-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<script>window.MathJax = {
   loader: { load: ["https://cdn.jsdelivr.net/gh/sonoisa/XyJax-v3@3.0.1/build/xypic.js"]},
   tex: {packages: {'[+]': ['xypic','bm']},
         macros: {  bm: ["\\boldsymbol{#1}", 1],
                    ut: ["\\underbrace{#1}_{\\text{#2}}", 2],
                    utt: ["\\underbrace{#1}_{\\substack{\\text{#2}\\\\\\text{#3}}}", 3] }
   }
};
</script>
<style>
   h1 {  border-bottom: 8px solid #557;}
   h2 {  border-bottom: 1px solid #ccc;}
   .greyproof {
      background-color: #f5f5f5;
      padding: 1em;
      margin: 1em 0;
      border-radius: 4px;
   }
</style>
<script>window.MathJax = {
   loader: { load: ["https://cdn.jsdelivr.net/gh/sonoisa/XyJax-v3@3.0.1/build/xypic.js"]},
   tex: {packages: {'[+]': ['xypic','bm']},
         macros: {  bm: ["\\boldsymbol{#1}", 1],
                    ut: ["\\underbrace{#1}_{\\text{#2}}", 2],
                    utt: ["\\underbrace{#1}_{\\substack{\\text{#2}\\\\\\text{#3}}}", 3] }
   }
};
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Ranking by Engagement | Tom Cunningham">
<meta name="twitter:description" content="Tom Cunningham blog">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tom Cunningham</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href=".././about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/testingham"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tom-cunningham-a9433/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://tecunningham.github.io/index.xml"> <i class="bi bi-rss-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=MDB_DgkAAAAJ"> 
<span class="menu-text">scholar</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Ranking by Engagement</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Tom Cunningham </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 8, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<style>
   h1 {  border-bottom: 4px solid black; }
   h2 {  border-bottom: 1px solid #ccc; }
   h3 { font-weight: bold; font-size: 1em; /*margin-left: -1em;*/ }
   h3~p { margin-left: 2em; }
   h3~ul { margin-left: 2em; }
   h3~ol { margin-left: 2em; }
   body {counter-reset: h3counter; }
   h3::before {
      content: counter(h3counter) ". ";
      counter-increment: h3counter;
   }
   
   dt { font-weight: normal; }
   dt strong { font-weight: bold; }
   dd { margin-left: 20px; }
   a { color: black; }
   /* dl { display: grid; grid-auto-flow: row;}
   dt { grid-column-start: 1; }
   dd { grid-column-start: 2; } */
</style>

<div class="no-row-height column-margin column-container"><div class="">
<p> Thanks to comments from Jeff Allen, Jacquelyn Zehner, David Evan Harris, Jonathan Stray, and others. If you find this note useful for your work send me an email and tell me :)</p>
</div><div class="">
<p><img src="images/2023-06-13-15-11-29.png" class="img-fluid"></p>
</div></div>
<p><strong>Six observations on ranking by engagement on social media platforms:</strong></p>
<ol type="1">
<li><p><strong>Platforms rank content primarily by the predicted probability of engagement.</strong> Platforms choose for each user the items they are predicted to click on, or reply to, or to retweet, etc.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p></li>
<li><p><strong>Platforms rank by engagement because it increases user retention.</strong> In experiments which compare engagement-ranked feeds to unranked feeds (“chronological” feeds) the users with engagement-ranked feeds consistently show substantially higher long-run retention (DAU) and time-spent. Platforms care about engagement not in itself but as a means to an end, and when faced with a tradeoff between engagement and retention would choose retention.</p></li>
<li><p><strong>Engagement is negatively related to quality.</strong> The content with the highest predicted engagement very often has low scores by various measures of objective quality: clickbait, spam, scams, misleading headlines, and misinformation. Intuitively this is because engagement only measures immediate appeal, and the most appealing content is often the most disappointing. Low quality content typically <em>hurts</em> retention, and as a consequence platforms often supplement their engagement-based ranking algorithms with a range of proxies for content quality.</p></li>
<li><p><strong>Sensitive content is often both engaging and retentive.</strong> Engagement-ranked feeds often increase the prevalence of various types of “sensitive” content: nudity, bad language, abuse, hate speech, hyper-partisan politics, etc.. However unlike low-quality content, reducing the prevalence of sensitive content often hurts retention, implying that sensitivity is positively correlated with retention.</p></li>
<li><p><strong>Sensitive content is often preferred by users.</strong> Platforms have tried out many experiments with asking users directly for their preferences over content. The results have been mixed, and platforms have often been disappointed to find that users express fairly positive attitudes towards content that the platform considers sensitive.</p></li>
<li><p><strong>Platforms don’t want sensitive content but don’t want to be seen to be removing it.</strong> Platform decision-makers often have principled reasons for limiting the distribution of certain types of sensitive content. Additionally there are instrumental reasons: sensitive content attracts negative attention from the media, advertisers, app stores, politicians, regulators, and investors. But platforms are also hesitant to directly target this content, especially when it has some political dimension. As a consequence platforms often target sensitive content indirectly by using proxies, and they prefer to justify their decision-making by appealing to user preferences or to user retention.</p></li>
</ol>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;In this note I’m using “engagement” to refer to individual actions not user-level metrics like time-spent or DAU.</p></div></div><div class="cell page-columns page-full" data-layout-align="center">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-28-ranking-by-engagement_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div></div></div>
<p><strong>In an appendix I formalize the argument.</strong> I show that all these observations can be expressed as covariances between different properties of content, e.g.&nbsp;between the retentiveness, predicted engagement rates, and other measures of content quality. From those covariances we can derive Pareto frontiers and visualize how platforms are trading-off between different outcomes.</p>
<p><br><br><br></p>
<section id="argument-in-detail" class="level1 page-columns page-full">
<h1>Argument in Detail</h1>
<section id="i-will-bucket-attributes-of-content-into-five-types" class="level3">
<h3 class="anchored" data-anchor-id="i-will-bucket-attributes-of-content-into-five-types">I will bucket attributes of content into five types</h3>
<ol type="1">
<li><em>Engagement:</em> the predicted probability of a user clicking, commenting, retweeting, etc., on a specific piece of content.</li>
<li><em>Retentiveness:</em> the causal contribution of seeing the content on a specific user’s long-term retention (e.g.&nbsp;DAU). Unlike the other attributes this can never be directly observed, only inferred from experiments.</li>
<li><em>Quality:</em> some objective measure of quality, e.g.&nbsp;whether fact-checked, whether the headline is misleading, whether the linked website has a high ad-load, whether the source is trustworthy, etc..</li>
<li><em>Sensitivity:</em> whether the content could be offensive, harmful, corrosive – e.g.&nbsp;nudity, bad language, abuse, hate speech.</li>
<li><em>Preference:</em> the user’s response to a survey question, e.g.&nbsp;“do you want to see more of this type of content?”</li>
</ol>
<p>Note that “quality” and “sensitivity” apply to individual pieces of content, while the other three attributes apply to relationship between a user and a piece of content.</p>
</section>
<section id="social-media-platforms-rank-their-content-primarily-by-predicted-engagement" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="social-media-platforms-rank-their-content-primarily-by-predicted-engagement">Social media platforms rank their content primarily by predicted engagement</h3>
<p>The core ranking model for most social platforms is a weighted average of predicted engagement rates.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;I believe this is true for almost all platforms with personalized recommendations including YouTube, Netflix, and Amazon. An excellent reference for how recommenders work, with illustrations and links, is Thorburn, Bengani, &amp; Stray (2022) <a href="https://medium.com/understanding-recommenders/how-platform-recommenders-work-15e260d9a15a">“How Platform Recommenders Work”</a></p></div><div id="fn3"><p><sup>3</sup>&nbsp;For simplicity the rest of the discussion treats the causal effect of content as purely separable.</p></div></div><p>However ranking functions also include hundreds of other tweaks incorporating non-engagement features, upranking or downranking content depending on, for example, the media type (photo/text/video), the relationship between the user and the author (whether you follow this person), various predictions of of objective quality (classifiers predicting whether the content is spam, offensive, adult, misinformation, etc.), or other features (network centrality, off-platform popularity, etc.). They also often have some diversity rules to prevent the content that is shown from being too similar.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Ranking by popularity is common for other media: we look at lists of bestsellers, most popular, highest grossing, most watched, or top charting. Attention is limited and it would be inefficient to offer people a random selection of everything that’s available.</p>
</section>
<section id="predicted-engagement-rates-are-mostly-historical-engagement-rates" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="predicted-engagement-rates-are-mostly-historical-engagement-rates">Predicted engagement rates are mostly historical engagement rates</h3>
<p>In many cases the most important predictors of whether a user will engage with a piece of content are (1) this user’s historical rate of engagement on similar pieces of content (e.g.&nbsp;content from the same author, or of the same media-type); (2) other users’ rate of engagement on this piece of content. Platforms do use more complicated models (embeddings and neural nets), those models typically are most valuable for qualitatively new types of content, when you have relatively sparse historical data either on the user or on the item.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;See discussion below of Covington et al.&nbsp;(2016) which describes an architecture commonly used in recommenders.</p></div></div></section>
<section id="platforms-care-primarily-about-long-run-retention-engagement-is-a-means-to-that-end" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="platforms-care-primarily-about-long-run-retention-engagement-is-a-means-to-that-end">Platforms care primarily about long-run retention, engagement is a means to that end</h3>
<p>The outcome that leadership care about the most is long-run retention, measured with metrics like Daily Active Users (DAU).<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> They would generally sacrifice substantial amounts of engagement in return for DAU. They also would sacrifice substantial short-term DAU if it could be shown with confidence that it would lead to higher long-term DAU.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Most publicly-traded platforms report in their quarterly earnings just one non-financial metric: the number of active users (DAU/MAU/mDAU, etc.). I do not know of any company that publicly reports a metric of aggregate engagement.</p></div></div><p>This point is often unclear because many changes to ranking (as measured in experiments) move engagement and retention in the same direction, and move short-run and long-run metrics in the same direction, meaning that we cannot easily tell which metric is decisive. Individual teams are often given targets to increase short-term engagement but that is mainly because that metric is easier to measure.</p>
<p></p>
</section>
<section id="engagement-ranked-feeds-have-substantially-higher-long-term-retention-and-time-spent-than-chronologically-ranked-feeds" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="engagement-ranked-feeds-have-substantially-higher-long-term-retention-and-time-spent-than-chronologically-ranked-feeds">Engagement-ranked feeds have substantially higher long-term retention and time-spent than chronologically-ranked feeds</h3>
<p>Users who are given engagement-ranked feeds in experiments typically have higher long-term DAU by single-digit percentages (1%-9%), and higher long-term time-spent by double-digit percentages (10%-99%). Accounting for network effects makes the aggregate difference even larger.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;<span class="citation" data-cites="huszar2022twitter">Huszár et al. (<a href="#ref-huszar2022twitter" role="doc-biblioref">2022</a>)</span> note that since Twitter introduced a ranked timeline in 2016 they maintained an experiment with 1% of users with a chronological feed.</p></div></div><ul>
<li><p><em>Meta 2020 experiments with chronological ranking showed a 20% time-spent decline on Facebook and a 10% decline on Instagram.</em> The experiments ran for 3 months and they reported the average effect over the whole period, it is likely that the time-spent effects continued declining. The effects on DAU were not reported. See <span class="citation" data-cites="guess2023chronological">Guess et al. (<a href="#ref-guess2023chronological" role="doc-biblioref">2023</a>)</span>.</p></li>
<li><p><em>A Facebook 2018 experiment showed a 3% decline in time-spent after 10 days.</em> The effects on time-spent seemed to be linearly trending down at the time the analysis was posted. Engagement (MSI) declined by about 20%, and politics impression reduced by 15% (the share of politics impressions is more complicated to calculate but seems unambiguously down). The effects on DAU were not reported (<a href="https://www.bigtechnology.com/p/facebook-removed-the-news-feed-algorithm?s=09">source</a>.). The experiment was not on a purely chronological feed: they retained “diversity rules, client-side ranking, read-state logging, comment-bumping” as well as integrity ranking rules.</p>
<p></p></li>
</ul>
</section>
<section id="engaging-content-is-often-low-quality" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="engaging-content-is-often-low-quality">Engaging content is often low quality</h3>
<p>Despite the positive relationship between engagement and retention, many studies have found that highly-engaging content is has lower-than-average quality:</p>
<ul>
<li><em>In summer 2016 half of Facebook’s most-seen posts related to the US election were misinformation.</em> As <a href="https://www.buzzfeednews.com/article/craigsilverman/viral-fake-election-news-outperformed-real-news-on-facebook">reported</a> by Craig Silverman at Buzzfeed. This exceeds the <em>average</em> rate of misinformation, i.e.&nbsp;the most-engaging posts have a much lower-than-average quality.</li>
<li><em>In 2019 Facebook’s top group and pages were run by troll farms.</em> A series of internal analyses by by Jeff Allen (<a href="https://s3.documentcloud.org/documents/21063547/oct-2019-facebook-troll-farms-report.pdf">subsequently leaked</a>) found that a substantial share of Facebook’s top pages, groups, and posts, were run by “troll farms,” whose main tactic was reposting copied content that had high engagement rates. </li>
<li><em>In 2019 Facebook’s high-quality content received lower engagement.</em> In the late 2010s Facebook maintained an internal “quality” score for content (FUSS=“Feed Unified Scoring System”). A data scientist’s analysis from 2019 (<a href="https://s3.documentcloud.org/documents/21063547/oct-2019-facebook-troll-farms-report.pdf">subsequently leaked, see p.10</a>) found that low-quality content had significantly higher predicted engagement rates.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></li>
<li><em>In 2021 Facebook’s most-viewed posts were very low quality.</em> Since early 2021 FB has been releasing a dataset of their 20 most-viewed links and posts. An <a href="https://lookerstudio.google.com/u/0/reporting/28bc32fd-a067-4b4a-9be0-637e8c9bd917/page/0Z3mC?s=g7_EWEyFjrc">Integrity Institute analysis</a> by Jeff Allen has found that each quarter 60-80% of the posts fail some basic checks, either “the account behind it is anonymous, is posting unoriginal content, using spammy page or group networks, or if the post or link violated Facebook’s community standards.”</li>
<li><em>In 2020 Twitter’s ranking has mixed effects on political content.</em> Huszar et al.&nbsp;(2021) compare political content of users who are randomized to ranked vs chronological feeds. They report (1) for political parties, ranked feed tends to amplify the right-wing parties somewhat more than left-wing parties (but the same does not hold for individual politicians); (2) for US media sources, ranked feed amplifies “sources that are more partisan compared to ones rated as center”.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></li>
<li><em>In 2020 FB and IG chronological-ranking experiments showed a 5-15% increase in political content.</em> <span class="citation" data-cites="guess2023chronological">Guess et al. (<a href="#ref-guess2023chronological" role="doc-biblioref">2023</a>)</span> found that replacing feed-ranking algorithms with simple chronological ranking (i.e., the most-recent posts are shown first) for 3 months (1) the share of impressions that were classified as political increased by 15% on Facebook and by 5% on Instagram, the share that were classified as “political news” increased by 40% on Facebook.</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;These correlations can be difficult to interpret: suppose there is no correlation between engagement and quality in the pool of all available content, there will nevertheless be a negative correlation among the subset of content that is <em>seen</em> if the ranking algorithm penalizes low-quality content, meaning low-engagement low-quality content will never be shown to users. It is unclear from the document whether the correlation is among content that is available, or content that is seen.</p></div><div id="fn8"><p><sup>8</sup>&nbsp;Bakshy et al.&nbsp;(2015) found that Facebook’s feed-ranking doesn’t substantially change the share of cross-cutting (across-the-aisle) content seen.</p></div></div></section>
<section id="many-platforms-have-found-that-increasing-quality-helps-retention" class="level3">
<h3 class="anchored" data-anchor-id="many-platforms-have-found-that-increasing-quality-helps-retention">Many platforms have found that increasing quality helps retention</h3>
<p>Platforms have tried to address quality problems by defining measures of objective quality:</p>
<ul>
<li><p><em>Facebook uses many heuristics and classifiers to identify various types of low-quality content:</em> Facebook identifies and downranks, among other things, engagement bait, links that go to ad-farms, scraped content, titles that withhold information, and titles that exaggerate information. In each case these types of content would generate high engagement but give users a bad experience, and in most cases experiments confirmed that dowranking these types of content increases long-run user retention.</p></li>
<li><p><em>Facebook uses some metadata features to identify low-quality content.</em> E.g. Facebook calculates the <a href="https://www.cnbc.com/2019/04/10/facebook-click-gap-google-like-approach-to-stop-fake-news-going-viral.html">“click gap”</a> (the amount of organic traffic a website gets) and <a href="https://www.wired.com/story/how-facebook-wants-to-improve-the-quality-of-your-news-feed/">“broad trust”</a> (diversity of engagement across users).</p>
<p></p></li>
<li><p><em>YouTube has introduced a series of quality adjustments to ranking:</em> E.g. downranking <a href="https://blog.youtube/inside-youtube/on-youtubes-recommendation-system/">“sensationalistic tabloid content”</a> and upranking <a href="https://blog.youtube/inside-youtube/on-youtubes-recommendation-system/">“authoritative content”</a>.</p></li>
</ul>
<p>Some companies have also shifted engagement weights to put relatively more weight on “deeper” measures of engagement:</p>
<ul>
<li><em>In 2012 YouTube switched from maximizing clicks to maximizing watch-time.</em> They found it led to a short-term decrease in clicks but a long-term <a href="https://blog.youtube/inside-youtube/on-youtubes-recommendation-system/">increase in retention</a>. I believe Netflix similarly has invested a lot of time in developing “deep” measures of engagement.</li>
</ul>
<p></p>
</section>
<section id="quality-also-helps-the-producer-ecosystem." class="level3">
<h3 class="anchored" data-anchor-id="quality-also-helps-the-producer-ecosystem.">Quality also helps the producer ecosystem.</h3>
<p>There is an additional reason for prioritizing the quality of content independent of the direct effect on user retention: because prioritizing high-quality content helps foster a long-run community of creators.</p>
<p>A central fact about social media is that it relies on a tremendous amount of uncompensated labor. Most content is created for the joy of creation, with little realistic expectation of financial return. The impulse to post clearly relies on a delicate social perception or norm, and a platform could inadvertantly break this spell. I think speaking loosely Facebook mismanaged their public-content ecosystem in this way: they alienated creators in a variety of ways, especially by allowing copied content to proliferate, and high-quality creators instead posted to Instagram, Twitter, YouTube, and Tik Tok. Facebook leadership tried to attract creators with various monetary incentives but they often backfired: creators who are financially-motivated are often not the creators you want.</p>
</section>
<section id="engagement-measures-immediate-quality-and-hence-is-a-poor-proxy-for-the-quality-of-factual-claims" class="level3">
<h3 class="anchored" data-anchor-id="engagement-measures-immediate-quality-and-hence-is-a-poor-proxy-for-the-quality-of-factual-claims">Engagement measures <em>immediate</em> quality, and hence is a poor proxy for the quality of factual claims</h3>
<p>Engagement necessarily measures the immediate reaction of a user to a piece of content, and thus ranking by predicted engagement will surface content that <em>appears</em> to be good. This is fine when there is no hidden aspect to quality, e.g.&nbsp;for jokes and pictures which mostly be judged in the moment. However if we rank informational content by predicted engagement it will tend to surface the claims that are the most sensational or intriguing independent of whether they are true.</p>
<p>If apples were sold only by how they looked, and not by how they tasted, then we would be offered delicious-looking and bland-tasting apples.</p>
<p>I believe this basic mechanism explains why internet platforms typically have higher rates of exaggerated, misleading, or false content compared to traditional media (newspapers, television, etc.). Traditional media do not publish whichever headlines would maximize short-run sales because that would harm long-run sales. This also explains why platforms have found that they can substantially improve retention by building proxies for quality.</p>
</section>
<section id="a-negative-relationship-between-engagement-and-quality-can-be-caused-by-unscrupulous-publishers" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="a-negative-relationship-between-engagement-and-quality-can-be-caused-by-unscrupulous-publishers">A negative relationship between engagement and quality can be caused by unscrupulous publishers</h3>
<p>Suppose each publisher can produce a fixed number of headlines, which will vary in (1) the headline’s propensity to be clicked, and (2) whether the headline is true. There are two types of publishers:</p>
<ol type="1">
<li>Honest publishers: they choose the most-engaging headlines from within the subset that are true.</li>
<li>Dishonest publishers: they choose the most-engaging headlines from the universe of all possible headlines (irrespective of truth).</li>
</ol>
<p>In this world the most-engaging headlines will be disproportionately false compared to the average headline. In the long run consumers will learn some skepticism, and to discount headlines in proportion to how clickable they seem, but they are unlikely to learn to discriminate perfectly. There’s always a chance that an intriguing headline will be true, and so the negative correlation would persist in equilibrium.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;A more formal version: each consumer sees a single headline with observed signal <span class="math inline">\(s\)</span> and chooses whether to click. The payoff from clicking is <span class="math inline">\(s\)</span> if it’s from an honest publisher, zero otherwise, and there’s some stochastic outside option so the consumer’s probability of clicking is continuously increasing in the expected payoff from clicking. Honest publishers report their signals drawn from <span class="math inline">\(f_H(s)\)</span>, dishonest publishers choose any signal. In equilibrium the dishonest publishers’ signal distribution, <span class="math inline">\(f_D(s)\)</span>, must be such that all signals with non-zero mass have have an equal click-through rate, meaning there is some <span class="math inline">\(\kappa\)</span> such that for every <span class="math inline">\(s&gt;\kappa\)</span>, <span class="math inline">\(f_D(s)=\frac{s-\kappa}{\kappa}f_H(s)\)</span>. Thus low click-through-rate headlines (<span class="math inline">\(s&lt;\kappa\)</span>) are all true, but high click-through rate headlines (<span class="math inline">\(s&gt;\kappa\)</span>) all have some share which are false. Qualitatively: if a headline is not very interesting, then you believe it; but if it’s interesting then you discount exactly inversely to how interesting it is. In this model we have (1) retentiveness (consumer surplus) is increasing with engagement; (2) quality (truth) is decreasing with engagement; (3) retentiveness (consumer surplus) would be higher if you rank by both engagement and quality (e.g.&nbsp;by removing false stories).</p></div></div></section>
<section id="platforms-have-been-slow-in-improving-the-quality-of-ranked-content" class="level3">
<h3 class="anchored" data-anchor-id="platforms-have-been-slow-in-improving-the-quality-of-ranked-content">Platforms have been slow in improving the quality of ranked content</h3>
<p>I discuss above some examples of Facebook’s slowness in addressing problems with the quality of content. I think this slowness is for two mains reasons. First, predicting engagement is a well-defined technical problem with a track record of success while evaluating content-quality is much more open-ended and difficult to validate. Hard-headed engineers often argue that a user’s preferences are revealed in their engagement and that evaluating quality is paternalistic. Secondly, platforms are nervous of being opinionated about objective quality because they don’t wish to take sides on politically delicate issues. In 2016 Facebook was criticized for using human judgment in determining what topics are “trending”, and in the wake of that criticism many projects which involved human judgment were shut down and replaced with automatic systems. Then in 2020 engineers on News Feed were told to avoid using words such as “trust” or “quality” or “authority”, and to instead use language that referred only to user preferences.</p>
<p></p>
<p></p>
</section>
<section id="sensitive-content-is-often-both-engaging-and-retentive" class="level3">
<h3 class="anchored" data-anchor-id="sensitive-content-is-often-both-engaging-and-retentive">Sensitive content is often both engaging and retentive</h3>
<p>I have defined “sensitive” content to include nudity, bad language, abuse, hate speech, hyper-partisan politics, etc.. Sensitive content often has higher-than-average engagement rates, and when content is demoted this often hurts retention, implying that sensitivity is positively correlated with retentiveness.</p>
<ul>
<li>A 2023 academic study by <a href="https://drive.google.com/file/d/1HYiBOGLNM91RBiqBlxKFvjDhJAuCxe60/view">Beknazar-Yuzbashev et al.</a> estimated that filtering the 7% most-toxic content on Facebook reduced overall Facebook content consumed by 20%. However the results look quite odd to me: they asked users to install a custom browser, which filtered out content. They estimate an extraordinarily high incrementality rate (greater than 2X), the dynamic treatment effects shown in Fig 13 are very weak, and I found it difficult to follow the arguments against differential attrition driving these results.</li>
</ul>
</section>
<section id="platforms-dont-want-to-show-sensitive-content" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="platforms-dont-want-to-show-sensitive-content">Platforms don’t want to show sensitive content</h3>
<p>Platforms are clearly prepared to pay a cost to reduce the prevalence of sensitive content, both in terms of retentiveness (DAU), and in the monetary cost of engineers, labelers, and computation.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;Platforms often spend around 5% of their total costs on content moderation, despite the prevalence of sensitive content and the effects on retention typically being closer to 0.1% or less.</p></div></div><p>The platforms have many reasons for avoiding sensitive content, independent of its effect on retention, but internally there is often an ambiguity about the contribution of different reasons. In part decisions are driven by a feeling of moral duty to not amplify content that is harmful. However there are also many instrumental reasons, because sensitive content often causes friction with advertisers, app stores, regulators, media, employees and investors.</p>
<p>Misinformation is a somewhat special case. From what has been discussed before, misinformation can be expected to reduce retention because it’s not true. However misinformation is very often related to sensitive issues, e.g.&nbsp;partisan politics, race relations, vaccines, and often reports falsehoods that support the viewer’s political prejudices.</p>
</section>
<section id="platforms-avoid-directly-penalizing-sensitive-content" class="level3">
<h3 class="anchored" data-anchor-id="platforms-avoid-directly-penalizing-sensitive-content">Platforms avoid directly penalizing sensitive content</h3>
<p>Platforms are caught in a double bind: there are strong pressures to reduce the amount of sensitive content on their platform, but there is also a pressure not to be seen to be making judgments about the objective value or harm of content. They want a garden with no weeds but they also wish to have clean hands. This often causes a bifurcation between the nominal reason for a policy and the real reason. Some examples:</p>
<ul>
<li><p><em>Platforms often downrank engagement patterns because they correlate with sensitive content.</em> It is common to downrank posts which features a specific engagement pattern (e.g.&nbsp;certain types of sharing, certain types of downstream attributes), and the downranking is justified internally based on the correlation with measures of quality or sensitivity, e.g.&nbsp;misinformation, or hate speech, or hyperpartisan content. This is odd because it would seem to be more efficient to target the sensitive content directly, i.e.&nbsp;instead of downranking the proxy, use the proxy as a feature in a classifier, and downrank based on the classifier output. However platforms avoid this approach in part because they are nervous about the perception of being perceiving as judges of the quality of content.</p></li>
<li><p><em>Platforms speak about sensitivity rules as if they were adopted to serve the interests of their users.</em> Google’s Jigsaw group has an influential set of definitions of content quality, their <a href="https://support.perspectiveapi.com/s/about-the-api-attributes-and-languages?language=en_US">definition</a> of a “toxic” comment is <em>“a rude, disrespectful, or unreasonable comment that is likely to make people leave a discussion.”</em> This definition is worded to presuppose that rude comments cause lower retention. The definition thus allows a platform to talk about their toxicity classifiers as if they were solely serving the interests of the users exposed to toxic language.</p></li>
<li><p><em>Survey questions are chosen based on their correlation with measures of sensitive content.</em> Platforms will often try out multiple different wordings of a survey question and decide which one to use by comparing the results with their internal measures of content quality and sensitivity, leading to survey questions that are somewhat awkwardly worded (e.g.&nbsp;asking people “is this good for the world?”).</p></li>
</ul>
</section>
<section id="subjective-user-ratings-of-quality-have-a-mixed-relationship-with-objective-measures-of-quality" class="level3">
<h3 class="anchored" data-anchor-id="subjective-user-ratings-of-quality-have-a-mixed-relationship-with-objective-measures-of-quality">Subjective user ratings of quality have a mixed relationship with objective measures of quality</h3>
<p>Platforms have often tried to collect explicit user feedback about quality, e.g.&nbsp;asking “was this worth your time?”, “do you want to see more of this?”, “was this informative?”. In my experience, for most such questions, responses are highly correlated with engagement, but often show a negative correlation with objective measures of quality. E.g. people often rate misinformation as “informative” and “worth my time.”</p>
<p>Nevertheless some of these initiatives have had success in raising both objective quality and retention, e.g.&nbsp;Facebook recently launched a prompt asking “would you like to see more posts like this?” The signal from this prompt apparently increases both retention and many objective measures of quality.</p>
<p></p>
</section>
<section id="platforms-additionally-care-about-engagement-because-of-network-effects" class="level3">
<h3 class="anchored" data-anchor-id="platforms-additionally-care-about-engagement-because-of-network-effects">Platforms additionally care about engagement because of network effects</h3>
<p>I said above that platforms care about engagement primarily insofar as it’s a proxy for retention, however there is an additional reason to pay attention to engagement. When one user engages (likes, comments, retweets) this increases the value of the platform to all the other users, and so has an indirect positive effect on retention. For this reason platforms are generally willing to sacrifice some retention in return for engagement, as measured in an experiment, if the sacrifice is sufficiently small.</p>
</section>
</section>
<section id="technical-appendix-expressed-as-a-covariance-matrix" class="level1">
<h1>Technical Appendix: Expressed as a Covariance Matrix</h1>
<p><strong>We can express most of the argument above with a covariance matrix.</strong> Given a user we can give scores to each piece of content with respect to the five attributes defined above. Then we can give a reasonable characterization of the platform ranking problem with the following covariance matrix:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 19%">
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 16%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">retentiveness</th>
<th style="text-align: center;">engagement</th>
<th style="text-align: center;">quality</th>
<th style="text-align: center;">sensitivity</th>
<th style="text-align: center;">preference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>retentiveness</strong></td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">+</td>
<td style="text-align: center;">+</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">+</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>engagement</strong></td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">+</td>
<td style="text-align: center;">+</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>quality</strong></td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>sensitivity</strong></td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">+</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>preference</strong></td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
<td style="text-align: center;">&nbsp;</td>
</tr>
</tbody>
</table>
<p><strong>Given this covariance matrix, we can draw Pareto frontiers and indifference curves.</strong> Each Pareto frontier represents the set of achievable tradeoffs between two outcomes. I explain below how elliptical Pareto frontiers and linear indifference curves can be derived from the covariance matrix if we assume that everything is distributed joint Normally.</p>
<p><strong>Retentiveness and engagement.</strong> We can draw a Pareto frontier between retention and engagement as below. We do not directly observe the retentiveness of content, but we know that ranking content by engagement (i.e.&nbsp;choosing the farthest right-hand point on the Pareto frontier) increases retention relative to an unranked feed, so we can infer that retentiveness and engagement are positively correlated, thus the Pareto ellipse must be upward-sloping.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-28-ranking-by-engagement_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p><strong>Engagement and quality.</strong> As discussed above, we often see that (1) measures of content quality have zero or negative correlation with engagement, (2) downranking low-quality content (equivalently, upranking high-quality content) increases retention. This is somewhat surprising because engagement and retention have a positive correlation, meaning the three correlations are not transitive.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-28-ranking-by-engagement_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="336"></p>
</figure>
</div>
</div>
</div>
<p>We illustrate the relationship with retention here with three lines representing different levels of retention, effectively these are indifference curves of a platform that is trying to maximize retention.</p>
<p><strong>Engagement and sensitivity.</strong> Next consider “sensitive” attributes. We often see that more sensitive content has higher engagement rates, shown below as an upward-tilt to the Pareto frontier. In addition experiments that penalize sensitive content often have a negative effect on retention: this could be either due to a positive partial correlation between engagement and retentiveness, or a positive partial correlation between sensitivity and retentiveness. But in either case it seems that sensitive content does not have a strong negative effect on retention.</p>
<p>Despite these facts, most platforms still put substantial penalties on sensitive content, either directly or indirectly (as discussed above), and they pay a price in terms of both engagement and retention.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-28-ranking-by-engagement_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p><strong>Preference and sensitivity.</strong> Finally consider a direct measure of user preference over content, e.g.&nbsp;asking users “is this informative?” or “would you like to see more like this?” In general user preference correlates relatively well with engagement, but it also offers incremental value for predicting retentiveness, in other words adding an additional term to the ranking function to predict user preference tends to increase retention.</p>
<p>However as discussed above, projects which collect survey questions are often focussed on the sensitivity of content rather than its retentiveness, and in that respect their findings are often mixed. Below we illustrate a case in which ranking by preference increases retentiveness but does not lower the amount of sensitive content (which platforms often desire). However platforms will offer try out many different wordings of survey questions, and each question will have somewhat different correlations.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-28-ranking-by-engagement_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<section id="formal-observations" class="level2">
<h2 class="anchored" data-anchor-id="formal-observations">Formal Observations</h2>
<p>Here I describe a few formal properties of a model of ranking based on a joint-normal distribution of attributes. Fuller proofs of some of these results are <a href="https://tecunningham.github.io/posts/2023-10-23-pareto-frontiers-experiments-ranking.html">here</a>, other are in notes I’m preparing and available on request.</p>
<ol type="1">
<li><p><strong>The covariance between item attributes will determine a Pareto frontier among outcomes.</strong> Suppose we know the joint distribution of attributes and we can choose a subset with share <span class="math inline">\(p\)</span> of the distribution (e.g.&nbsp;a fixed number of impressions given a pool of possible stories to show), and we want to calculate the average value of each attribute in the subset of content shown to the user. Then we can describe the Pareto frontier over subsets, i.e.&nbsp;the set of realized average outcomes, and it will be a function of the covariances among attributes over pieces of content. With 2 attributes the Pareto frontier will be an ellipse with shape exactly equal to an isoprobability curve from the joint density.</p>
<p>The shape of the ellipse has a simple interpretation. If two attributes are positively correlated then the Pareto frontier will be <em>tight</em> meaning there is little tradeoff, i.e.&nbsp;we will have similar aggregate outcomes independent of the relative weights put on each outcome in ranking. If instead two attributes are negatively correlated then the Pareto frontier will be <em>loose</em> meaning outcomes will vary a lot with the relative weights used in ranking.</p>
<p>Our assumption that the share <span class="math inline">\(p\)</span> is fixed is equivalent to assuming that any ranking rule will get the same number of impressions. This assumption obviously has some tension with <em>retentiveness</em> being an outcome variable: if some ranking rule has low retentiveness, then we would expect lower impressions. Accounting for this would make the Pareto frontier significantly more complicated to model, for simplicity we can interpret every attribute except retentiveness as a short-run outcome. Alternatively we could interpret them as relative instead of absolute outcomes, e.g.&nbsp;as engagement/impression or engagement/DAU.</p></li>
<li><p><strong>Improving a classifiers will stretch the Pareto frontier.</strong> As a classifier gets better the average prediction will stay the same but the variance will increase, meaning the Pareto frontier will stretch out, and given a linear indifference curve we can derive the effect on outcomes.</p></li>
<li><p><strong>The joint distribution plus utility weights will determine ranking weights.</strong> If we observe only some outcomes then we can calculate the conditional expectation for other outcomes. Typically we want to know retentiveness, and we can write the conditional expectation as follows: <span class="math display">\[E[\text{retentiveness}|
   \text{engagement},\ldots,\text{user preference}].\]</span> This expectation has a closed-form solution when the covariance matrix is joint normal. When we have just two signals, for example engagement and quality, we can write:</p>
<span class="math display">\[\begin{aligned}
   E[r|e,q] &amp;= \frac{1}{1-\gamma^2}(\rho_e-\gamma\rho_q)e +
               \frac{1}{1-\gamma^2}(\rho_q-\gamma\rho_e)q\\
   r     &amp;= \text{retentiveness}\\
   e     &amp;= \text{engagement (predicted)}\\
   q     &amp;= \text{quality (predicted)}\\
   \rho_{e}     &amp;= \text{covariance of engagement and retentiveness}\\
   \rho_{q}     &amp;= \text{covariance of quality and retentiveness}\\
   \gamma     &amp;= \text{covariance of engagement and quality}
\end{aligned}\]</span>
<p>Note that the slope of the iso-retentiveness line in <span class="math inline">\((e,q)\)</span>-space will be <span class="math inline">\(-\frac{\rho_e-\gamma\rho_q}{\rho_q-\gamma\rho_e}\)</span>.</p></li>
<li><p><strong>Experiments which vary ranking weights tell us about covariances.</strong> We can write findings from experiments as follows. First, suppose we find that retention is higher when ranked by engagement than when unranked, this can be written:</p>
<span class="math display">\[\begin{aligned}
      \utt{E[r|e&gt;e^*]}{ranked by}{engagement} &amp;&gt; \ut{E[r]}{unranked}
   \end{aligned}\]</span>
<p>Here <span class="math inline">\(e^*\)</span> is chosen such that <span class="math inline">\(P(e&gt;e^*)=p\)</span> for some <span class="math inline">\(p\)</span>, representing the share of potential inventory that the user consumes. This implies that engagement must positively correlate with retentiveness, <span class="math inline">\(\rho_e&gt;0\)</span>.</p>
<p>Next we can express that retention is higher when we put some weight <span class="math inline">\(\beta\)</span> on quality:</p>
<span class="math display">\[\begin{aligned}
   \utt{E[r|e+\beta q&gt;\kappa^*]}{ranked by}{engagement and quality} &amp;&gt; \utt{E[r|e&gt;e^*]}{ranked by}{engagement}
\end{aligned}\]</span>
<p>Here <span class="math inline">\(\kappa^*\)</span> is chosen such that <span class="math inline">\(P(e+\beta q &gt; \kappa^*)=P(e&gt;e^*)=p\)</span>. If <span class="math inline">\(\beta\)</span> is fairly small then we can infer that the iso-retentiveness line is downward-sloping, implying: <span class="math display">\[\frac{\rho_e-\gamma\rho_q}{\rho_q-\gamma\rho_e}&gt;0.\]</span></p>
<p>This implies that both engagement and quality have the same sign. I don’t think they both can be negative, so they both must be positive:</p>
<span class="math display">\[\begin{aligned}
      \rho_e - \gamma \rho_q &amp;&gt; 0 \\
      \rho_q - \gamma \rho_e &amp;&gt; 0.
   \end{aligned}\]</span></li>
<li><p><strong>I think it’s reasonable to treat preferences as locally linear.</strong> To have a well-defined maximization problem (with an interior solution) we need either nonlinear preferences or a nonlinear Pareto frontier. It’s always easier to treat things as linear when you can, so a relevant question is which of these two is closer to linear? Internally companies often treat their preferences as nonlinear, e.g.&nbsp;setting specific goals and guardrails, but those are always flexible and often have justifications as incentive devices. Typical metric changes are small, only single-digit percentage points, over that range the Pareto frontier does show significant diminishing returns while (it seems to me) value to the company does not.</p></li>
</ol>
</section>
</section>
<section id="appendix-literature-on-ranking-and-recommendation" class="level1">
<h1>Appendix: Literature on Ranking and Recommendation</h1>
<section id="overviews-of-recommender-systems-chronological" class="level2">
<h2 class="anchored" data-anchor-id="overviews-of-recommender-systems-chronological">Overviews of Recommender Systems (chronological)</h2>
<dl>
<dt><strong>Adomavicius and Tuzhilin (2005) “Toward the Next Generation of Recommender Systems: A Survey of the State-of-the-Art and Possible Extensions”</strong></dt>
<dd>
An influential overview of recommender systems (14,000 citations!). The canonical example is recommending movies to get the highest predicted rating. They use “rating” as similar to “engagement”. A more recent survey is <a href="https://journalofbigdata.springeropen.com/articles/10.1186/s40537-022-00592-5">Roy and Dutta (2022)</a>.
</dd>
<dt><strong>Davidson et al.&nbsp;(2010) <a href="https://www.inf.unibz.it/~ricci/ISR/papers/p293-davidson.pdf">“The YouTube Video Recommendation System”</a></strong></dt>
<dd>
<blockquote class="blockquote">
<p>“[videos] are scored and ranked using … signals [which] can be broadly categorized into three groups corresponding to three different stages of ranking: 1) video quality, 2) user specificity and 3) diversification.””</p>
</blockquote>
</dd>
<dd>
<blockquote class="blockquote">
<p>“The primary metrics we consider include click through rate (CTR), long CTR (only counting clicks that led to watches of a substantial fraction of the video), session length, time until first long watch, and recommendation coverage (the fraction of logged in users with recommendations).”</p>
</blockquote>
</dd>
<dd>
<p>They say recommendations are good because they have high click-through rate. - <a href="https://blog.youtube/news-and-events/youtube-now-why-we-focus-on-watch-time/">A blog post from 2012</a> discusses a switch from views to watch time: <em>“Our video discovery features were previously designed to drive views. This rewarded videos that were successful at attracting clicks, rather than the videos that actually kept viewers engaged. (Cleavage thumbnails, anyone?)”</em></p>
</dd>
<dt><strong>Gomez-Uribe and Hunt (2015) <a href="https://dl.acm.org/doi/abs/10.1145/2843948">“The Netflix Recommender System: Algorithms, Business Value, and Innovation”</a></strong></dt>
<dd>
Clearly states that they evaluate AB tests using engagement, but it is regarded as an imperfect proxy for retention:
</dd>
<dd>
<blockquote class="blockquote">
<p><em>“we have observed that improving engagement—the time that our members spend viewing Netflix content—is strongly correlated with improving retention. Accordingly, we design randomized, controlled experiments … to compare the medium-term engagement with Netflix along with member cancellation rates across algorithm variants. Algorithms that improve these A/B test metrics are considered better.”</em></p>
</blockquote>
</dd>
</dl>
<p><strong>Covington et al.&nbsp;(2016) <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45530.pdf">“Deep Neural Networks for YouTube Recommendations”</a></strong></p>
<p>This paper proposed a very influential architecture for content recommendation (the paper has 3000 citations). They say:</p>
<blockquote class="blockquote">
<p>“Our final ranking objective is constantly being tuned based on live A/B testing results but is generally a simple function of expected watch time per impression. Ranking by click-through rate often promotes deceptive videos that the user does not complete (“clickbait”) whereas watch time better captures engagement”</p>
</blockquote>
<p><strong>Lada, Wang, &amp; Yan (2021, FB Blog) <a href="https://tech.facebook.com/engineering/2021/1/news-feed-ranking/">How does news feed predict what you want to see?</a></strong></p>
<dl>
<dt><strong>Thorburn, Bengani, &amp; Stray (2022, Understanding Recommenders) <a href="https://medium.com/understanding-recommenders/how-platform-recommenders-work-15e260d9a15a">“How Platform Recommenders Work”</a></strong></dt>
<dd>
<p>This is an excellent short article with description and illustration of the stages in building a slate of content: moderation, candidate generation, ranking, and reranking. Includes links to many posts from platforms describing their systems.</p>
</dd>
<dd>
<p><img src="images/2023-07-31-15-45-00.png" class="img-fluid"></p>
</dd>
<dd>
<p><img src="images/2023-07-31-16-09-47.png" class="img-fluid"></p>
</dd>
<dt><strong>Arvin Narayanan (2023) <a href="https://knightcolumbia.org/content/understanding-social-media-recommendation-algorithms">“Understanding Social Media Recommendation Algorithms”</a></strong></dt>
<dd>
<p>A good overview of recommendation algorithms, with an in-depth discussion of Facebook’s MSI.</p>
</dd>
<dd>
<p>Criticisms of social media recommendation: (1) harm users because “implicit-feedback-based feeds cater to our basest impulses,” (2) harm creators because “engagement optimization … is a fickle overlord,” (3) harms society because “social media platforms are weakening institutions by undermining their quality standards and making them less trustworthy. While this has been widely observed in the case of news … my claim is that every other institution is being affected, even if not to the same degree.”</p>
</dd>
<dd>
<p>The technical part of the essay is excellent but I found some of the arguments about harm and social effects hard to follow.</p>
</dd>
</dl>
<p><strong><span class="citation" data-cites="kleinberg2022challenge">Kleinberg, Mullainathan, and Raghavan (<a href="#ref-kleinberg2022challenge" role="doc-biblioref">2022</a>)</span></strong></p>
</section>
<section id="proposals-for-change-chronological" class="level2">
<h2 class="anchored" data-anchor-id="proposals-for-change-chronological">Proposals for Change (chronological)</h2>
<dl>
<dt><strong>Andrew Mauboussin (2022, SurgeAI) <a href="https://www.surgehq.ai/blog/what-if-social-media-optimized-for-human-values">“Moving Beyond Engagement: Optimizing Facebook’s Algorithms for Human Values”</a></strong></dt>
<dd>
Says that the problem is <em>“the most engaging content is often the most toxic.”</em> They propose using human raters, e.g.&nbsp;ask people “did this post make you feel closer to your friends and family on a 1-5 scale?” They label a small set of FB posts as a proof of concept.
</dd>
<dt><strong>Bengani, Stray, &amp; Thorburn (2022,Medium) <a href="https://medium.com/understanding-recommenders/whats-right-and-what-s-wrong-with-optimizing-for-engagement-5abaac021851">“What’s Right and What’s Wrong with Optimizing for Engagement”</a></strong></dt>
<dd>
They define engagement as “a set of user behaviors, generated in the normal course of interaction with the platform, which are thought to correlate with value to the user, the platform, or other stakeholders.” Reviews evidence for good and bad effects of ranking by engagement.
</dd>
</dl>
<p><strong>Ovadya &amp; Thorburn (2023). <a href="https://doi.org/10.48550/arXiv.2301.09976">Bridging Systems: Open Problems for Countering Destructive Divisiveness across Ranking, Recommenders, and Governance</a></strong></p>
<dl>
<dt><strong>Stray, Iyer, Larrauri (2023) <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4429558">“The Algorithmic Management of Polarization and Violence on Social Media”</a></strong></dt>
<dd>
<ol type="1">
<li>Our overall goal should be to minimize “destructive conflict”.</li>
</ol>
</dd>
<dd>
<ol start="2" type="1">
<li>The major lever used has been content moderation: changing the visibility of content based on semantic criteria (e.g.&nbsp;downranking toxic, disallowing hate speech).</li>
</ol>
</dd>
<dd>
<ol start="3" type="1">
<li>However we should put relatively more work on system design, e.g.&nbsp;adding friction or changing the mechanics of sharing or engagement-based ranking. In part because there’s a robust correlation between content that causes destructive conflict and content that is engaging.</li>
</ol>
</dd>
</dl>
<p><strong><span class="citation" data-cites="milli2021optimizing">Milli, Belli, and Hardt (<a href="#ref-milli2021optimizing" role="doc-biblioref">2021</a>)</span> (2021) “From Optimizing Engagement to Measuring Value”</strong></p>
<dl>
<dt><strong>Milli, Pierson and Garg (2023) <a href="https://arxiv.org/abs/2305.17428">Choosing the Right Weights: Balancing Value, Strategy, and Noise in Recommender Systems</a></strong></dt>
<dd>
<p>I find the model a little hard to follow. </p>
</dd>
</dl>
<p></p>
<dl>
<dt><strong>Lubin &amp; Gilbert (2023) <a href="https://arxiv.org/abs/2306.07443">“Accountability Infrastructure: How to implement limits on platform optimization to protect population health”</a></strong></dt>
<dd>
<p>A very wide-ranging and loose discussion of issues related to ranking content. Makes an analogy with 19th century measures to control public health. I think the main proposal is that firms come up with metrics to measure their effect on social problems such as mental health, and regularly report on how they’re doing. They suggest requirements for platforms of different sizes:</p>
</dd>
<dd>
<table class="caption-top table">
<colgroup>
<col style="width: 2%">
<col style="width: 97%">
</colgroup>
<tbody>
<tr class="odd">
<td>1M+</td>
<td>Submitted plan for metrics and methods for evaluation of potential structural harms</td>
</tr>
<tr class="even">
<td>10M+</td>
<td>Consistent data collection on potential structural harms</td>
</tr>
<tr class="odd">
<td>50M+</td>
<td>Quarterly, enforceable assessments on product aggregate effects on structural harms, with breakouts for key subgroups</td>
</tr>
<tr class="even">
<td>100M+</td>
<td>Monthly, enforceable assessments on product aggregate effects as well as targeted assessments of specific product rollouts for any subproduct used by at least 50 million users, with breakouts for key subgroups</td>
</tr>
</tbody>
</table>
</dd>
</dl>
</section>
</section>
<section id="appendix-taxonomy-of-metrics" class="level1">
<h1>Appendix: Taxonomy of Metrics</h1>
<p>This is meant to be a parsimonious taxonomy of metrics used in a recommender. They are organized by the the types of entity they apply to. For simplicity I omit aggregations (e.g.&nbsp;a user’s like rate is just the average over likes over user-item pairs), and I omit predictions (e.g.&nbsp;an item’s pToxic is just the prediction of whether a paid rater would rate the item as toxic).</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 24%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th><strong>entity</strong></th>
<th><strong>type of metric</strong></th>
<th><strong>metric</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>user</td>
<td>activity</td>
<td>login (DAU/DAP)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>time spent</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>evaluation</td>
<td>survey (“are you satisfied?”)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>item</td>
<td>paid rater</td>
<td>policy-violating (“does this violate policy?”)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>quality evaluation (“does this fit quality defn?”)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>objective features</td>
<td>recency</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>item contains author info</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>item contains link</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>producer</td>
<td>objective features</td>
<td>off-platform popularity</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>graph statistics</td>
<td>network centrality</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>user-item</td>
<td>social interaction</td>
<td>like (heart/fav/emoji reaction)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>comment (reply)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>reshare (retweet/forward)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>downstream interactions</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>interest signal</td>
<td>linger (time spent watching)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>click (follow link, expand)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>evaluation</td>
<td>star-rating</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>upvote (downvote)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>survey (“did you find this worth your time?”)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>see-more</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>dislike (see less)</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>other</td>
<td>report</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>dislike</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>user-producer</td>
<td>interest signal</td>
<td>follow (subscribe, friend)</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>block</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="references" class="level1">




</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-guess2023chronological" class="csl-entry" role="listitem">
Guess, Andrew M., Neil Malhotra, Jennifer Pan, Pablo Barberá, Hunt Allcott, Taylor Brown, Adriana Crespo-Tenorio, et al. 2023. <span>“How Do Social Media Feed Algorithms Affect Attitudes and Behavior in an Election Campaign?”</span> <em>Science</em> 381 (6656): 398–404. <a href="https://doi.org/10.1126/science.abp9364">https://doi.org/10.1126/science.abp9364</a>.
</div>
<div id="ref-huszar2022twitter" class="csl-entry" role="listitem">
Huszár, Ferenc, Sofia Ira Ktena, Conor O’Brien, Luca Belli, Andrew Schlaikjer, and Moritz Hardt. 2022. <span>“Algorithmic Amplification of Politics on Twitter.”</span> <em>Proceedings of the National Academy of Sciences</em> 119 (1): e2025334119. <a href="https://doi.org/10.1073/pnas.2025334119">https://doi.org/10.1073/pnas.2025334119</a>.
</div>
<div id="ref-kleinberg2022challenge" class="csl-entry" role="listitem">
Kleinberg, Jon, Sendhil Mullainathan, and Manish Raghavan. 2022. <span>“The Challenge of Understanding What Users Want: Inconsistent Preferences and Engagement Optimization.”</span> <a href="https://arxiv.org/abs/2202.11776">https://arxiv.org/abs/2202.11776</a>.
</div>
<div id="ref-milli2021optimizing" class="csl-entry" role="listitem">
Milli, Smitha, Luca Belli, and Moritz Hardt. 2021. <span>“From Optimizing Engagement to Measuring Value.”</span> In <em>Proceedings of the 2021 ACM Conference on Fairness, Accountability, and Transparency</em>, 714–22.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{cunningham2023,
  author = {Cunningham, Tom},
  title = {Ranking by {Engagement}},
  date = {2023-05-08},
  url = {tecunningham.github.io/posts/2023-04-28-ranking-by-engagement.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-cunningham2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Cunningham, Tom. 2023. <span>“Ranking by Engagement.”</span> May 8,
2023. <a href="https://tecunningham.github.io/posts/2023-04-28-ranking-by-engagement.html">tecunningham.github.io/posts/2023-04-28-ranking-by-engagement.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("tecunningham\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>